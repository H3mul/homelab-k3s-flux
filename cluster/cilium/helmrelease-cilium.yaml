apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: cilium
  namespace: kube-system
spec:
  chart:
    spec:
      chart: cilium
      version: 1.16.2
      sourceRef:
        kind: HelmRepository
        name: cilium-charts
        namespace: flux-system
      interval: 15m
  interval: 15m
  timeout: 5m
  releaseName: cilium
  values:

    # Values:
    # https://github.com/cilium/cilium/blob/3261be3fea2dfb3ca90deb69a85e848d13286fa5/install/kubernetes/cilium/values.yaml

    # Guide for BGP:
    # https://baremetalblog.com/posts/tech/2024-03-12-cilium-bgp-and-you/

    cluster:
        id: 1
        name: homelab
    k8sServiceHost: homelab.${CLUSTER_DOMAIN}
    k8sServicePort: 6443
    kubeProxyReplacement: true

    l2announcements:
      enabled: true

    loadBalancer:
      algorithm: maglev

    bgpControlPlane:
      enabled: true

    externalIPs:
      enabled: true

    bpf:
      masquerade: true

    cni:
      exclusive: true  # Different from guide

    hubble:
      enabled: false

    ipam:
      mode: kubernetes

    operator:
      replicas: 1
      rollOutPods: true
      prometheus:
          enabled: false
          serviceMonitor:
              enabled: false

    rollOutCiliumPods: true

    prometheus:
      enabled: true
      serviceMonitor:
          enabled: false

    encryption:
      enabled: true
      type: wireguard
      nodeEncryption: false

    egressGateway:
      enabled: false

    serviceAccounts:
      cilium:
          name: cilium
      operator:
          name: cilium-operator

    # securityContext:
    #   privileged: true