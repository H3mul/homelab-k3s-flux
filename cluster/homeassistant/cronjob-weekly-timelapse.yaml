apiVersion: batch/v1
kind: CronJob
metadata:
  name: weekly-timelapse
  namespace: homeassistant
spec:
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 2
  concurrencyPolicy: Forbid
  schedule: '0 0 * * 0' # Every Sunday at midnight
  jobTemplate:
    spec:
      backoffLimit: 2 
      activeDeadlineSeconds: 3600 # 1 hour timeout for video processing
      template:
        spec:
          restartPolicy: Never
          containers:

          - name: timelapser
            image: ghcr.io/h3mul/timelapser:v0.1.0
            imagePullPolicy: Always

            securityContext:
              runAsUser: ${FILESHARE_USER_ID}
              runAsGroup: ${FILESHARE_GROUP_ID}
              fsGroup: ${FILESHARE_GROUP_ID}
              fsGroupChangePolicy: "OnRootMismatch"

            env:
              - name: PERIOD_DAYS
                value: "7"
              - name: INPUT_DIR
                value: "/media/plant_watch"
              - name: OUTPUT_DIR
                value: "/media/plant_watch"

            volumeMounts:
            - name: media-volume
              mountPath: /media
            - name: tmp-volume
              mountPath: /tmp

          volumes:
          - name: media-volume
            persistentVolumeClaim:
              claimName: homeassistant-media
          - name: tmp-volume
            emptyDir: {}
