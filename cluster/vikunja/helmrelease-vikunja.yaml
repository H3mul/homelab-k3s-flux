apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: vikunja
  namespace: vikunja
spec:
  chart:
    spec:
      chart: app-template
      version: 1.5.x
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  interval: 15m
  timeout: 5m
  releaseName: vikunja
  values:
    initContainers:
      init-db:
        image: ghcr.io/onedr0p/postgres-init:16.4@sha256:e41c745b54485341e00efbd27556f0717623a119f0d5107e5ff831aa1322c76f
        imagePullPolicy: IfNotPresent
        env:
          - name: POSTGRES_HOST
            value: postgres-cluster-rw.cloudnative-pg.svc.cluster.local
          - name: POSTGRES_SUPER_USER
            valueFrom:
              secretKeyRef:
                name: postgres-cluster-superuser
                key: username
          - name: POSTGRES_SUPER_PASS
            valueFrom:
              secretKeyRef:
                name: postgres-cluster-superuser
                key: password
          - name: INIT_POSTGRES_DBNAME
            valueFrom:
              secretKeyRef:
                name: vikunja-postgres-credentials
                key: POSTGRES_DB
          - name: INIT_POSTGRES_USER
            valueFrom:
              secretKeyRef:
                name: vikunja-postgres-credentials
                key: POSTGRES_USER
          - name: INIT_POSTGRES_PASS
            valueFrom:
              secretKeyRef:
                name: vikunja-postgres-credentials
                key: POSTGRES_PASS

    image:
      repository: caddy
      tag: 2.8-alpine@sha256:33937b9d51461ea87794350c1c09ce53f327802508929d78f3b5642533f2f7db
      pullPolicy: IfNotPresent
    sidecars:
      frontend:
        image: vikunja/frontend:0.22.1@sha256:f0223d441997fe29c377d0b476dc4bb2fc091b44b9c24d76b1b88c213df520c5
      api:
        image: vikunja/api:0.22.1@sha256:c9415431e6235229302bb8f9ee6660b74c24859d1e8adbc4a3e25bd418604b57
        env:
          - name: VIKUNJA_SERVICE_TIMEZONE
            value: ${TIMEZONE}
          - name: VIKUNJA_DATABASE_TYPE
            value: 'postgres'
          - name: VIKUNJA_SERVICE_FRONTENDURL
            value: https://vikunja.${CLUSTER_DOMAIN}
          - name: VIKUNJA_DATABASE_USER
            valueFrom:
              secretKeyRef:
                name: vikunja-postgres-credentials
                key: POSTGRES_USER
          - name: VIKUNJA_DATABASE_PASSWORD
            valueFrom:
              secretKeyRef:
                name: vikunja-postgres-credentials
                key: POSTGRES_PASS
          - name: VIKUNJA_DATABASE_DATABASE
            valueFrom:
              secretKeyRef:
                name: vikunja-postgres-credentials
                key: POSTGRES_DB
          - name: VIKUNJA_DATABASE_HOST
            value: postgres-cluster-rw.cloudnative-pg.svc.cluster.local
        volumeMounts:
          - name: files
            mountPath: /app/vikunja/files

    service:
      main:
        ports:
          http:
            port: 8080
    ingress:
      main:
        enabled: true
        ingressClassName: 'nginx'
        hosts:
          - host: &host 'vikunja.${CLUSTER_DOMAIN}'
            paths:
              - path: /
                pathType: Prefix
        tls:
          - hosts:
              - *host

    configMaps:
      caddy-config:
        enabled: true
        data:
          Caddyfile: |-
              {
                admin off
                auto_https off
              }
              :8080 {
                  log {
                      output stdout
                  }
                  @api {
                      path /api/*
                      path /.well-known/*
                      path /dav/*
                  }
                  header {
                      # Remove Server header
                      -Server
                  }
                  # API
                  handle @api {
                      reverse_proxy localhost:3456
                  }
                  # Filtron
                  handle {
                      reverse_proxy localhost:80
                  }
              }

    persistence:
      files:
        enabled: true
        existingClaim: vikunja-files
        mountpath: /app/vikunja/files
      caddy-config:
        enabled: true
        name: vikunja-caddy-config
        type: configMap
        mountPath: /etc/caddy/Caddyfile
        subPath: Caddyfile