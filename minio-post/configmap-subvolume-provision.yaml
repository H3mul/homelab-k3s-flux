apiVersion: v1
kind: ConfigMap
metadata:
  name: minio-provision-script
  namespace: minio
  annotations:
    # Avoid variable substitution of shell variables bellow
    kustomize.toolkit.fluxcd.io/substitute: disabled
data:
  provision-minio.sh: |
    #!/bin/bash

    set -e
    [ -z "${VERBOSE}" ] || set -x

    die() {
      local msg=$1
      local code=${2-1} # default exit status 1
      msg "$msg"
      exit "$code"
    }

    msg() {
      echo >&2 -e "[+] ${1-}"
    }

    [ -z "${MINIO_ROOT_USER}" ] && die "'MINIO_ROOT_USER' variable is required to be set"
    [ -z "${MINIO_ROOT_PASSWORD}" ] && die "'MINIO_ROOT_PASSWORD' variable is required to be set"
    [ -z "${MINIO_HOST}" ] && die "'MINIO_HOST' variable is required to be set"

    [ -z "${GROUP_NAME}" ] && die "'GROUP_NAME' variable is required to be set"
    [ -z "${ACCESS_KEY}" ] && die "'ACCESS_KEY' variable is required to be set"
    [ -z "${SECRET_KEY}" ] && die "'SECRET_KEY' variable is required to be set"

    [ -z "${POLICY_NAME}"] && POLICY_NAME=$(cat /policy/policy-name.txt)
    [ -z "${POLICY_NAME}"] && die "'POLICY_NAME' needs to be set or successfully retrieved from /policy/policy-name.txt"

    msg "Connecting to ${MINIO_HOST}..."
    /usr/bin/mc config host add myminio ${MINIO_HOST} ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD}
    # /usr/bin/mc tree myminio

    msg "Checking connection to host..."
    /usr/bin/mc admin info myminio

    msg "Creating user ${ACCESS_KEY} and group ${GROUP_NAME}..."
    /usr/bin/mc admin user add myminio ${ACCESS_KEY} ${SECRET_KEY}
    /usr/bin/mc admin group add myminio ${GROUP_NAME} ${ACCESS_KEY} 

    msg "Creating the policy ${POLICY_NAME}..."
    /usr/bin/mc admin policy add myminio ${POLICY_NAME} /policy/policy.json

    msg "Adding the policy ${POLICY_NAME} to group ${GROUP_NAME}..."
    /usr/bin/mc admin policy set myminio ${POLICY_NAME} group=${GROUP_NAME}

    msg "Creating bucket(s): ${BUCKET_NAMES} ..."

    # Need to render to a string variable first - bash variable expansion happens after brace expansion when both are used in a single command:
    # https://www.gnu.org/software/bash/manual/html_node/Shell-Expansions.html
    # We add a comma at the end so it works even if there is only 1 bucket name 
    IFS=,
    for bucket in ${BUCKET_NAMES}; do
      /usr/bin/mc ls myminio/${bucket} || /usr/bin/mc mb myminio/${bucket}
    done 
    unset IFS
