apiVersion: batch/v1
kind: Job
metadata:
  name: minio-provision
  namespace: minio
spec:
  # Destroy job after completion - otherwise an existing job conflicts with reconcile
  ttlSecondsAfterFinished: 60 
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: minio-provision
        image: minio/mc
        command: ["/bin/sh", "-c"]
        args: ["/script/provision-minio.sh"]
        imagePullPolicy: IfNotPresent

        env:
        - name: MINIO_HOST
          value: https://s3.${CLUSTER_DOMAIN}
        - name: GROUP_NAME
          value: volsync
        - name: BUCKET_NAMES
          value: volsync
        - name: ACCESS_KEY
          value: ${ACCESS_KEY}
        - name: SECRET_KEY
          value: ${SECRET_KEY}

        - name: VERBOSE
          value: "true"
          
        envFrom:
          - secretRef:
              # MINIO_ROOT_USER, MINIO_ROOT_PASSWORD
              name: minio-server-credentials

        volumeMounts:
        - name: minio-provision-script
          mountPath: /script

        - name: s3-policy
          mountPath: /policy

      volumes:
      - name: minio-provision-script
        configMap:
          name: minio-provision-script
          defaultMode: 0500

      - name: s3-policy
        configMap:
          name: volsync-minio-s3-group-policy
          defaultMode: 0400
