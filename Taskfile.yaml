version: "3"

vars:
  PROJECT_DIR:
    sh: "git rev-parse --show-toplevel"

includes:
  templates: .taskfiles/templates.yaml

tasks:
  default:
    silent: true
    cmds:
      - go-task -l

  k-seal:
    desc: kubeseal a secret yaml file
    preconditions:
      - sh: "test '{{.file}}' != '<no value>'"
        msg: "Variable .file is not set"
      - sh: "test -f {{.file}}"
        msg: "File {{.file}} does not exist"
    vars:
      filename:
        sh: basename {{.file}}
      dir:
        sh: dirname {{.file}}
    cmds:
      - kubeseal --cert sealed-secrets.pem < {{.file}} > {{.dir}}/sealed-{{.filename}} -o yaml


  k-events:
    desc: Watch kubernetes events in namespace
    vars:
      namespace: "{{.ns}}"
    preconditions:
      - sh: "[ '{{.namespace}}' != '<no value>' ]"
        msg: "Variable .namespace is not set"
    cmds:
      - watch "kubectl -n {{.namespace}} get events --sort-by='{.lastTimestamp}' | tail -n 15"
