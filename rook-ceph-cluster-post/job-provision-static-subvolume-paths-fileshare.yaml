apiVersion: batch/v1
kind: Job
metadata:
  name: provision-static-subvolume-paths-fileshare
  namespace: rook-ceph
spec:
  # Destroy job after completion - otherwise an existing job conflicts with reconcile
  ttlSecondsAfterFinished: 60
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: provision-static-subvolume-paths-fileshare
        image: rook/ceph:master
        command: ["/bin/bash", "-m", "-c"]
        args: ["/usr/local/bin/toolbox.sh --skip-watch && /script/subvolume-provision.sh"]
        imagePullPolicy: IfNotPresent
        env:
        - name: ROOK_CEPH_FS_NAME
          value: ceph-filesystem
        - name: ROOK_CEPH_SUBVOLUMEGROUP_NAME
          value: static-storage
        - name: ROOK_CEPH_SUBVOLUME_NAME
          value: fileshare
        - name: ROOK_CEPH_SUBVOLUME_DIRS
          value: share/Torrent
        - name: ROOK_CEPH_SUBVOLUME_USER_ID
          value: "'${FILESHARE_USER_ID}'"
        - name: ROOK_CEPH_SUBVOLUME_GROUP_ID
          value: "'${FILESHARE_GROUP_ID}'"

        - name: VERBOSE
          value: "1"

        - name: ROOK_CEPH_USERNAME
          valueFrom:
            secretKeyRef:
              name: rook-ceph-mon
              key: ceph-username
        securityContext:
          privileged: true
          runAsUser: 0
        volumeMounts:
        - mountPath: /dev
          name: dev
        - mountPath: /sys/bus
          name: sysbus
        - mountPath: /lib/modules
          name: libmodules
        - name: mon-endpoint-volume
          mountPath: /etc/rook
        - name: ceph-admin-secret
          mountPath: /var/lib/rook-ceph-mon
        - name: subvolume-provision-script
          mountPath: /script
      # if hostNetwork: false, the "rbd map" command hangs, see https://github.com/rook/rook/issues/2021
      hostNetwork: true
      volumes:
      - name: ceph-admin-secret
        secret:
          secretName: rook-ceph-mon
          optional: false
          items:
            - key: ceph-secret
              path: secret.keyring
      - name: dev
        hostPath:
          path: /dev
      - name: sysbus
        hostPath:
          path: /sys/bus
      - name: libmodules
        hostPath:
          path: /lib/modules
      - name: mon-endpoint-volume
        configMap:
          name: rook-ceph-mon-endpoints
          items:
            - key: data
              path: mon-endpoints
      - name: subvolume-provision-script
        configMap:
          name: subvolume-provision-script
          defaultMode: 0500